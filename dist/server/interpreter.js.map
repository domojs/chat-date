{"version":3,"sources":["../interpreter.ts"],"names":[],"mappings":"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","file":"interpreter.js","sourcesContent":["import * as di from 'akala-core';\r\nimport * as $ from 'underscore';\r\nimport { Interpreter, Context as BaseContext } from '../../../chat';\r\nimport * as util from 'util';\r\nimport * as debug from 'debug';\r\nimport * as Sugar from 'sugar';\r\nimport 'sugar/locales/fr';\r\nvar log = debug('domojs:chat:date');\r\nSugar.Date.setLocale('fr');\r\n\r\nexport interface Context extends BaseContext\r\n{\r\n    timeStart?: number;\r\n    time?: Date;\r\n    timeEnd?: number;\r\n}\r\n\r\ndi.injectWithName(['interpreters'], function (interpreters: Interpreter[])\r\n{\r\n    interpreters.push(dateInterpreter);\r\n})();\r\n\r\nfunction dateInterpreter(cmd: Context, next: (error?: any) => void, callback: (answer: string) => void)\r\n{\r\n    var text = cmd.text;\r\n    var timeStart = cmd.timeStart || 0;\r\n    var relativeTimes = [];\r\n\r\n    relativeTimes = relativeTimes.concat($.map($.filter(Sugar.Date.getLocale()['modifiers'], function (item: { src: string })\r\n    {\r\n        return text.indexOf(item.src, timeStart) >= 0;\r\n    }), function (item) { return item.src; }));\r\n    relativeTimes = relativeTimes.concat($.filter(Sugar.Date.getLocale()['months'], function (item: string)\r\n    {\r\n        return text.indexOf(item, timeStart) >= 0;\r\n    }));\r\n    relativeTimes = relativeTimes.concat($.filter(Sugar.Date.getLocale()['units'], function (item: string)\r\n    {\r\n        return text.indexOf(item, timeStart) >= 0;\r\n    }));\r\n\r\n    relativeTimes = relativeTimes.concat($.filter(Sugar.Date.getLocale()['weekdays'], function (item: string)\r\n    {\r\n        return text.indexOf(item, timeStart) >= 0;\r\n    }));\r\n    relativeTimes = relativeTimes.concat($.filter(Sugar.Date.getLocale()['tokens'], function (item: string)\r\n    {\r\n        return text.indexOf(item, timeStart) >= 0;\r\n    }));\r\n    if (text.indexOf(Sugar.Date.getLocale()['timeMarker'], timeStart) > -1)\r\n        relativeTimes = relativeTimes.concat(Sugar.Date.getLocale()['timeMarker']);\r\n\r\n    log(util.inspect(relativeTimes));\r\n\r\n    var relativeTime = Sugar.Array.unique($.filter($.map(relativeTimes, function (relativeTime)\r\n    {\r\n        return text.indexOf(relativeTime, timeStart)\r\n    }), function (item) { return item >= timeStart }).sort(function (a, b) { return a - b; }));\r\n\r\n    if (relativeTime.length == 0)\r\n        return next();\r\n\r\n    log(util.inspect(relativeTime));\r\n\r\n    var timeEnd = 1;\r\n    while (!cmd.time || relativeTime.length >= 1)\r\n    {\r\n        timeEnd = relativeTime[relativeTime.length - 1];\r\n        if (text.indexOf(Sugar.Date.getLocale()['timeMarker'], timeStart) == timeEnd)\r\n            timeEnd = text.indexOf(' ', text.indexOf(' ', timeEnd) + 1) + 1;\r\n        else\r\n            timeEnd = text.indexOf(' ', timeEnd) + 1;\r\n\r\n        if (relativeTime.length < 2 || timeEnd == 0)\r\n            timeEnd = text.length + 1;\r\n        timeStart = relativeTime[0];\r\n\r\n        log(timeStart + ',' + timeEnd);\r\n\r\n        var time = text.substring(timeStart, timeEnd - 1).trim();\r\n        log(time);\r\n        cmd.timeStart = timeStart;\r\n        cmd.timeEnd = timeEnd;\r\n        cmd.time = Sugar.Date.create(time.replace(/h([0-5][0-9])/, ':$1'));\r\n        if (Sugar.Date.isValid(cmd.time))\r\n            break;\r\n        if (relativeTime.length == 1)\r\n        {\r\n            cmd.time = Sugar.Date.create('aujourd\\'hui ' + time.replace(/h([0-5][0-9])/, ':$1'));\r\n            if (Sugar.Date.isValid(cmd.time))\r\n                break;\r\n        }\r\n        relativeTime.pop();\r\n    }\r\n    if (!Sugar.Date.isValid(cmd.time) && time != '' && typeof (time) != 'undefined')\r\n    {\r\n        log('new start');\r\n        log(time);\r\n        log('not understood');\r\n        cmd.timeStart++;\r\n\r\n        return dateInterpreter.apply(this, arguments);\r\n    }\r\n    cmd.text = text.substring(0, timeStart) + text.substring(timeEnd);\r\n    log(cmd.time && cmd.time.toISOString());\r\n    if (Sugar.Date.isPast(cmd.time))\r\n    {\r\n        return next('je ne peux pas remonter le temps');\r\n    }\r\n    cmd.deferred = true;\r\n    next();\r\n    if (cmd.deferred)\r\n    {\r\n        console.log(cmd);\r\n        cmd.deferred = false;\r\n        var timer = setTimeout(next, Sugar.Date.millisecondsFromNow(cmd.time))\r\n\r\n        callback(\"ok, je m'en charge \" + Sugar.Date.relative(cmd.time));\r\n    }\r\n}"],"sourceRoot":"chat-date/src/server"}